@page NimBLE Developer's Guide
@tableofcontents

@section A0 "Overview"
##Overview##
    * [Nimbulous]
    * [Tools]
    * [MCU]
    * [MPU]
    * [Linux]


[Tools](./Tools_Utils_Guide.md)
[MCU](./zDK_Bootloader_Guide.md)
[Linux](./zDK_Linux_Environment_Setup_Guide.md)
[MPU](./zDK_Protect_Image_Guide.md)

@subsection explain What is NimBLE
            1.  ***What is NimBLE:***

             A Bluetooth Low Energy (BLE) or Bluetooth Smart stack fully compliant with Bluetooth 5 specifications with support for Bluetooth Mesh. It is called NimBLE.

             BLE technology operates in the unlicensed industrial, scientific and medical (ISM) band at 2.4 to 2.485 GHz which is available in most countries. It uses a spread spectrum, frequency hopping, full-duplex signal. BLE FHSS employs 40 2-MHz-wide channels to ensure greater reliability over longer distances. It also features 0-dBm (1 mW) power output and a typical maximum range of 50 meters. With Bluetooth 5 specification range can be increased 4 times and speed 2 time.

@subsection modules Components
            2. ***Components:***

                A Bluetooth low energy stack (NimBLE included) consists of two components with several subcomponents:
                + Controller
                    + **Physical Layer**: adaptive frequency-hopping Gaussian Frequency Shift Keying (GFSK) radio using 40 RF channels (0-39), with 2 MHz spacing.
                    + Link Layer: with one of five states (Standby, Advertising, Scanning, Initiating, Connection states) active at any time
                + Host
                     + **Logical Link Control and Adaptation Protocol (L2CAP)**: provides logical channels, named L2CAP channels, which are multiplexed over one or more logical links to provide packet segmentation and reassembly, flow control, error control, streaming, QoS etc.
                     + Security Manager (SM): uses Security Manager Protocol (SMP) for pairing and transport specific key distribution for securing radio communication
                     + **Attribute protocol (ATT)**: allows a device (Server) to expose certain pieces of data, known as Attributes, to another device (Client)
                     + **Generic Attribute Profile (GATT)**: a framework for using the ATT protocol to exchange attributes encapsulated as Characteristics or Services
                     + **Generic Access Profile (GAP)**: a base profile which all Bluetooth devices implement, which in the case of LE, defines the Physical Layer, Link Layer, L2CAP, Security Manager, Attribute Protocol and Generic Attribute Profile.
                     + **Host Controller Interface (HCI)**: the interface between the host and controller either through software API or by a hardware interface such as SPI, UART or USB.
                .
@subsection security Security
            3. ***Nimble security:***
.
@par
                The Bluetooth Low Energy security model includes five distinct security concepts as listed below. For detailed specifications, see BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A].
                    + **Pairing**: The process for creating one or more shared secret keys. In LE a single link key is generated by combining contributions from each device into a link key used during pairing.
                    + **Bonding**: The act of storing the keys created during pairing for use in subsequent connections in order to form a trusted device pair.
                    + **Device authentication**: Verification that the two devices have the same keys (verify device identity)
                    + **Encryption**: Keeps message confidential. Encryption in Bluetooth LE uses AES-CCM cryptography and is performed in the Controller.
                    + **Message integrity**: Protects against message forgeries.
.
@par
                Bluetooth LE uses four association models depending on the I/O capabilities of the devices.
                    + **Just Works**: designed for scenarios where at least one of the devices does not have a display capable of displaying a six digit number nor does it have a keyboard capable of entering six decimal digits.
                    + **Numeric Comparison**: designed for scenarios where both devices are capable of displaying a six digit number and both are capable of having the user enter “yes” or “no”. A good example of this model is the cell phone / PC scenario.
                    + **Out of Band**: designed for scenarios where an Out of Band mechanism is used to both discover the devices as well as to exchange or transfer cryptographic numbers used in the pairing process.
                    + **Passkey Entry**: designed for the scenario where one device has input capability but does not have the capability to display six digits and the other device has output capabilities. A good example of this model is the PC and keyboard scenario.

@page BLE2 NimBLE API
###2. NimBLE API
        1. Configure device address
            + **Syscfg value set:**
                The NimBLE controller package exports a syscfg setting called BLE_PUBLIC_DEV_ADDR. This setting can be overridden at the application or target level to configure a public Bluetooth address. For example, a target can assign the public address ***11:22:33:44:55:66*** as follows:
                * Syscfg.h:
~~~{.c}
#ifndef MYNEWT_VAL_BLE_PUBLIC_DEV_ADDR
#define MYNEWT_VAL_BLE_PUBLIC_DEV_ADDR ((uint8_t[6]){0x66, 0x55, 0x44, 0x33, 0x22, 0x11})
#endif.
~~~
            This setting takes the form of a C expression. Specifically, the value is a designated initializer expressing a six-byte array. Also note that the bytes are reversed, as an array is inherently little-endian, while addresses are generally expressed in big-endian.
            + ***Configure a random address at runtime:***
    Random addresses get configured through the NimBLE host. The following two functions are used in random address configuration:
                * **ble_hs_id_gen_rnd:** Generates a new random address.
                * **ble_hs_id_set_rnd:** Sets the device’s random address.
        2. HAL API
@par
            Initialize the nimble hal layer module，include HW, OS, host and controller.
~~~{.c}
        void nimble_hal_init（void;
~~~
            Ensure functions only gets called one time during nimble initialization.
                * **void nimble_sysinit_start(void);**
                * **void nimble_sysinit_end(void);**
        3. Host API
            * Host GAP API
@par
                + Searches for a connection with the specified handle.  If a matching connection is found, the supplied connection descriptor is filled correspondingly.
@par
~~~{.c}

        int ble_gap_conn_find(uint16_t handle, struct ble_gap_conn_desc out_desc);
~~~
        @param[in] handle       The connection handle to search for.
        @param[out] out_desc    On success, this is populated with information relating to the matching connection.  Pass NULL if you don't need this information.
        @return                 0 on success, BLE_HS_ENOTCONN if no matching connection was
                   found.
.
@par
        This function configures and start advertising procedure.
~~~{.c}
    int ble_gap_adv_start(uint8_t own_addr_type,
                      const ble_addr_t direct_addr,
                      int32_t duration_ms,
                      const struct ble_gap_adv_params adv_params,
                      ble_gap_event_fn cb, void cb_arg);
~~~
        @param[in] own_addr_type The type of address the stack should use for itself.
                       Valid values are:
                          - BLE_OWN_ADDR_PUBLIC
                          - BLE_OWN_ADDR_RANDOM
                          - BLE_OWN_ADDR_RPA_PUBLIC_DEFAULT
                          - BLE_OWN_ADDR_RPA_RANDOM_DEFAULT
        @param[in] direct_addr   The peer's address for directed advertising. his
                       parameter shall be non-NULL if directed advertising is
                       being used.
        @param[in] duration_ms   The duration of the advertisement procedure. On
                       expiration, the procedure ends and a
                       BLE_GAP_EVENT_ADV_COMPLETE event is reported. Units are
                       milliseconds. Specify BLE_HS_FOREVER for no expiration.
        @param[in] adv_params    Additional arguments specifying the particulars of the
                       advertising procedure.
        @param[in] cb            The callback to associate with this advertising
                       procedure.  If advertising ends, the event is reported
                       through this callback.  If advertising results in a
                       connection, the connection inherits this callback as its event-reporting mechanism.
        @param[in] cb_arg        The optional argument to pass to the callback function.

        @return              0 on success, error code on failure.
@par
Stops the currently-active advertising procedure.  A success return
code indicates that advertising has been fully aborted and a new advertising procedure can be initiated immediately.
@code{.c}
int ble_gap_adv_stop(void);
@endcode

Indicates whether an advertisement procedure is currently in progress.
@return 0 if no advertisement procedure in progress, 1 otherwise.
@code{.c}
int ble_gap_adv_active(void);
@endcode

Configures the data to include in subsequent advertisements.
@param[in] data      Buffer containing the advertising data.
@param[in] data_len  The size of the advertising data, in bytes.
@return          0 on succes,  BLE_HS_EBUSY if advertising is in progress,
                   other error code on failure.
@code{.c}
int ble_gap_adv_set_data(const uint8_t data, int data_len);
@endcode

Configures the data to include in subsequent scan responses.
@param[in] data      Buffer containing the scan response data.
@param[in] data_len  The size of the response data, in bytes.
@return          0 on succes,  BLE_HS_EBUSY if advertising is in progress,
                 other error code on failure.
@code{.c}
int ble_gap_adv_rsp_set_data(const uint8_t data, int data_len);
@endcode

Configures the fields to include in subsequent advertisements.  This is a
convenience wrapper for ble_gap_adv_set_data().
@param[in] adv_fields    Specifies the advertisement data.
@return              0 on success,
                     BLE_HS_EBUSY if advertising is in progress,
                     BLE_HS_EMSGSIZE if the specified data is too large to
                     fit in an advertisement,
                     other error code on failure.
@code{.c}
int ble_gap_adv_set_fields(const struct ble_hs_adv_fields rsp_fields);
@endcode

Configures the fields to include in subsequent scan responses.  This is a
convenience wrapper for ble_gap_adv_rsp_set_data().
@param[in] adv_fields   Specifies the scan response data.
@return              0 on success,
                     BLE_HS_EBUSY if advertising is in progress,
                     BLE_HS_EMSGSIZE if the specified data is too large to
                     fit in a scan response,
                     other error code on failure.
@code{.c}
int ble_gap_adv_rsp_set_fields(const struct ble_hs_adv_fields rsp_fields);
@endcode

Performs the Limited or General Discovery Procedures.
@param[in] own_addr_type         The type of address the stack should use for
                             itself when sending scan requests.  Valid
                             values are:
                                     - BLE_ADDR_TYPE_PUBLIC
                                     - BLE_ADDR_TYPE_RANDOM
                                     - BLE_ADDR_TYPE_RPA_PUB_DEFAULT
                                     - BLE_ADDR_TYPE_RPA_RND_DEFAULT
                                 This parameter is ignored unless active
                                 scanning is being used.
@param[in] duration_ms           The duration of the discovery procedure.
                             On expiration, the procedure ends and a
                             BLE_GAP_EVENT_DISC_COMPLETE event is
                             reported.  Units are milliseconds.  Specify
                             BLE_HS_FOREVER for no expiration.
@param[in] disc_params           Additional arguments specifying the particulars
                             of the discovery procedure.
@param[in] cb                    The callback to associate with this discovery
                             procedure.  Advertising reports and
                             discovery termination events are reported
                             through this callback.
@param[in] cb_arg                The optional argument to pass to the callback
                             function.
@return                      0 on success; nonzero on failure.
@code{.c}
int ble_gap_disc(uint8_t own_addr_type, int32_t duration_ms,
                 const struct ble_gap_disc_params disc_params,
                 ble_gap_event_fn cb, void cb_arg);
@endcode
r reset, the variable x has the value 5. Initialized variable of this
Cancels the discovery procedure currently in progress.  A success return
code indicates that scanning has been fully aborted; a new discovery or
connect procedure can be initiated immediately.
@return                     0 on success;
                            BLE_HS_EALREADY if there is no discovery
                            procedure to cancel;
                            Other nonzero on unexpected error.
@code{.c}
int ble_gap_disc_cancel(void);
@endcode

Indicates whether a discovery procedure is currently in progress.
@return                      0: No discovery procedure in progress;
                             1: Discovery procedure in progress.
@code{.c}
int ble_gap_disc_active(void);
@endcode


Initiates a connect procedure.
@param[in] own_addr_type         The type of address the stack should use for
                             itself during connection establishment.
                                     - BLE_OWN_ADDR_PUBLIC
                                     - BLE_OWN_ADDR_RANDOM
                                     - BLE_OWN_ADDR_RPA_PUBLIC_DEFAULT
                                     - BLE_OWN_ADDR_RPA_RANDOM_DEFAULT
@param[in] peer_addr             The address of the peer to connect to.
                                 If this parameter is NULL, the white list
                                 is used.
@param[in] duration_ms           The duration of the discovery procedure.
                                 On expiration, the procedure ends and a
                                 BLE_GAP_EVENT_DISC_COMPLETE event is
                                 reported.  Units are milliseconds.
@param[in] conn_params           Additional arguments specifying the particulars
                                 of the connect procedure.  Specify null for
                                 default values.
@param[in] cb                    The callback to associate with this connect
                                 procedure.  When the connect procedure
                                 completes, the result is reported through
                                 this callback.  If the connect procedure
                                 succeeds, the connection inherits this
                                 callback as its event-reporting mechanism.
@param[in] cb_arg                The optional argument to pass to the callback
                                 function.
@return                      0 on success;
                             BLE_HS_EALREADY if a connection attempt is
                                 already in progress;
                             BLE_HS_EBUSY if initiating a connection is not
                                 possible because scanning is in progress;
                             BLE_HS_EDONE if the specified peer is already
                                 connected;
                             Other nonzero on error.
@code{.c}
int ble_gap_connect(uint8_t own_addr_type, const ble_addr_t peer_addr,
                    int32_t duration_ms,
                    const struct ble_gap_conn_params params,
                    ble_gap_event_fn cb, void cb_arg);
@endcode

Aborts a connect procedure in progress.
@return                      0 on success;
                             BLE_HS_EALREADY if there is no active connect
                             procedure.
                             Other nonzero on error.
@code{.c}
int ble_gap_conn_cancel(void);
@endcode


 Indicates whether a connect procedure is currently in progress.
 @return                      0: No connect procedure in progress;
                              1: Connect procedure in progress.

@code{.c}
int ble_gap_conn_active(void);
@endcode


Terminates an established connection.
@param[in] conn_handle           The handle corresponding to the connection to
                                     terminate.
@param[in] hci_reason                The HCI error code to indicate as the reason
                                  for termination.
@return                      0 on success;
                              BLE_HS_ENOTCONN if there is no connection with
                              the specified handle;
                           Other nonzero on failure.
@code{.c}
int ble_gap_terminate(uint16_t conn_handle, uint8_t hci_reason);
@endcode


 Initiates the GAP security procedure.
    Depending on connection role and stored security information this function
    will start appropriate security procedure (pairing or encryption).
 @param[in] conn_handle      The handle corresponding to the connection to secure.
 @return                 0 on success;
                         BLE_HS_ENOTCONN if the there is no connection
                              with the specified handle;
                         BLE_HS_EALREADY if an security procedure for
                               this connection is already in progress;
                         Other nonzero on error.
@code{.c}
int ble_gap_security_initiate(uint16_t conn_handle);
@endcode


2.3.2 Host GATT API

Adjusts a host configuration object's settings to accommodate the specified
service definition array.  This function adds the counts to the appropriate
fields in the supplied configuration object without clearing them first, so
it can be called repeatedly with different inputs to calculate totals.  Be
sure to zero the GATT server settings prior to the first call to this
function.

@param[in] defs                  The service array containing the resource
                                   definitions to be counted.

@return                      0 on success;
                               BLE_HS_EINVAL if the svcs array contains an
                                   invalid resource definition.
@code{.c}
XXX int ble_gatts_count_cfg(const struct ble_gatt_svc_def defs);
@endcode

Queues a set of service definitions for registration.  All services queued
in this manner get registered when ble_gatts_start() is called.

@param[in] svcs                  An array of service definitions to queue for
                                   registration.  This array must be
                                   terminated with an entry whose 'type'
                                   equals 0.

@return                      0 on success;
                               BLE_HS_ENOMEM on heap exhaustion.
@code{.c}
int ble_gattc_disc_all_chrs(uint16_t conn_handle, uint16_t start_handle,
                            uint16_t end_handle, ble_gatt_chr_fn cb,
                            void cb_arg);
@endcode


Initiates GATT procedure: Discover All Primary Services.
@param[in] conn_handle           The connection over which to execute the
                                   procedure.
@param[in] cb                    The function to call to report procedure status
                                   updates; null for no callback.
@param[in] cb_arg                The optional argument to pass to the callback
                                   function.
@code{.c}
int ble_gattc_disc_all_svcs(uint16_t conn_handle,
                            ble_gatt_disc_svc_fn cb, void cb_arg);
@endcode


Initiates GATT procedure: Discover All Characteristics of a Service.
@param[in] conn_handle           The connection over which to execute the
                                   procedure.
@param[in] start_handle          The handle to begin the search at (generally
                                   the service definition handle).
@param[in] end_handle            The handle to end the search at (generally the
                                   last handle in the service).
@param[in] cb                    The function to call to report procedure status
                                   updates; null for no callback.
@param[in] cb_arg                The optional argument to pass to the callback
                                   function.
@return                      0 on success; nonzero on failure.
@code{.c}
int ble_gattc_disc_all_chrs(uint16_t conn_handle, uint16_t start_handle,
                            uint16_t end_handle, ble_gatt_chr_fn cb,
                            void cb_arg);
@endcode


Initiates GATT procedure: Exchange MTU.
@param[in] conn_handle           The connection over which to execute the
                                  procedure.
@param[in] cb                    The function to call to report procedure status
                                   updates; null for no callback.
@param[in] cb_arg                The optional argument to pass to the callback
                                   function.
@return                      0 on success; nonzero on failure.
@code{.c}
int ble_gattc_exchange_mtu(uint16_t conn_handle,
                           ble_gatt_mtu_fn cb, void cb_arg);
@endcode


Initiates GATT procedure: Discover Characteristics by UUID.
        int ble_gattc_disc_chrs_by_uuid(uint16_t conn_handle, uint16_t start_handle,
                               uint16_t end_handle, const ble_uuid_t uuid,
                               ble_gatt_chr_fn cb, void cb_arg);

        @param[in] conn_handle           The connection over which to execute the procedure.
        @param[in] start_handle          The handle to begin the search from (generally
                                  the service definition handle).
        @param[in] end_handle            The handle to end the search at (generally the
                                                     last handle in the service).
        @param[in] chr_uuid128           The 128-bit UUID of the characteristic to
                 discover.
        @param[in] cb                    The function to call to report procedure status
                                  updates; null for no callback.
        @param[in] cb_arg                The optional argument to pass to the callback
                                                 function.
        @return                      0 on success; nonzero on failure.

@page BLE3 Nimble Data Structures

### Nimble Data Struct

## Host configuration structure ##

3.1 BLE HOST Struct

Those can be used by application to configure stack.

~~~{.c}
    struct ble_hs_cfg {
    
        An optional callback that gets executed upon registration of each GATT
        resource (service, characteristic, or descriptor).
        ble_gatt_register_fn gatts_register_cb;
    
    
        An optional argument that gets passed to the GATT registration
        callback.
        void gatts_register_arg;
    
        Security Manager Local Input Output Capabilities
        uint8_t sm_io_cap;
    
        @brief Security Manager OOB flag
    
         If set proper flag in Pairing Request/Response will be set.
        unsigned sm_oob_data_flag:1;
    
        @brief Security Manager Bond flag
    
         If set proper flag in Pairing Request/Response will be set. This results
         in storing keys distributed during bonding.
        unsigned sm_bonding:1;
    
        @brief Security Manager MITM flag
    
        If set proper flag in Pairing Request/Response will be set. This results
        in requiring Man-In-The-Middle protection when pairing.
        unsigned sm_mitm:1;
    
        @brief Security Manager Secure Connections flag
    
         If set proper flag in Pairing Request/Response will be set. This results
         in using LE Secure Connections for pairing if also supported by remote
         device. Fallback to legacy pairing if not supported by remote.
         unsigned sm_sc:1;
    
        @brief Security Manager Key Press Notification flag
        Currently unsupported and should not be set.
        unsigned sm_keypress:1;
    
        @brief Security Manager Local Key Distribution Mask
        uint8_t sm_our_key_dist;
    
        @brief Security Manager Remote Key Distribution Mask
        uint8_t sm_their_key_dist;
    
        @brief Stack reset callback
         This callback is executed when the host resets itself and the controller
          due to fatal error.
          ble_hs_reset_fn reset_cb;
    
        @brief Stack sync callback
         This callback is executed when the host and controller become synced.
         This happens at startup and after a reset.
         ble_hs_sync_fn sync_cb;
    
        XXX: These need to go away. Instead, the nimble host package should
        require the host-store API (not yet implemented)..
        Storage Read callback handles read of security material
        ble_store_read_fn store_read_cb;
    
        Storage Write callback handles write of security material
        ble_store_write_fn store_write_cb;
    
        Storage Delete callback handles deletion of security material
        ble_store_delete_fn store_delete_cb;
    
        @brief Storage Status callback.
         This callback gets executed when a persistence operation cannot be
          performed or a persistence failure is imminent. For example, if is
          insufficient storage capacity for a record to be persisted, this
          function gets called to give the application the opportunity to make
          room.
          ble_store_status_fn store_status_cb;
    
        An optional argument that gets passed to the storage status callback.
        void store_status_arg;
    }
~~~

3.2 NimBLE GAP Data Struct

Connection security state


~~~{.c}
    struct ble_gap_sec_state {
    If connection is encrypted
    unsigned encrypted:1;

    If connection is authenticated
    unsigned authenticated:1;

    If connection is bonded (security information is stored)
    unsigned bonded:1;

    Size of a key used for encryption
    unsigned key_size:5;
    };
~~~



Advertising parameters
~~~{.c}
struct ble_gap_adv_params {
    Advertising mode. Can be one of following constants:
      - BLE_GAP_CONN_MODE_NON (non-connectable; 3.C.9.3.2).
      - BLE_GAP_CONN_MODE_DIR (directed-connectable; 3.C.9.3.3).
      - BLE_GAP_CONN_MODE_UND (undirected-connectable; 3.C.9.3.4).

    uint8_t conn_mode;
    Discoverable mode. Can be one of following constants:
      - BLE_GAP_DISC_MODE_NON  (non-discoverable; 3.C.9.2.2).
      - BLE_GAP_DISC_MODE_LTD (limited-discoverable; 3.C.9.2.3).
      - BLE_GAP_DISC_MODE_GEN (general-discoverable; 3.C.9.2.4).

    uint8_t disc_mode;

    Minimum advertising interval, if 0 stack use sane defaults
    uint16_t itvl_min;
    Maximum advertising interval, if 0 stack use sane defaults
    uint16_t itvl_max;
    Advertising channel map , if 0 stack use sane defaults
    uint8_t channel_map;

    Advertising  Filter policy
    uint8_t filter_policy;

    If do High Duty cycle for Directed Advertising
    uint8_t high_duty_cycle:1;
};
~~~

~~~{.c}
struct ble_gap_conn_desc {
    Connection security state
    struct ble_gap_sec_state sec_state;

    Local identity address
    ble_addr_t our_id_addr;

    Peer identity address
    ble_addr_t peer_id_addr;

    Local over-the-air address
    ble_addr_t our_ota_addr;

    Peer over-the-air address
    ble_addr_t peer_ota_addr;

    Connection handle
    uint16_t conn_handle;

    Connection interval
    uint16_t conn_itvl;

    Connection latency
    uint16_t conn_latency;

    Connection supervision timeout
    uint16_t supervision_timeout;

    Connection Role
     Possible values BLE_GAP_ROLE_SLAVE or BLE_GAP_ROLE_MASTER

    uint8_t role;

    Master clock accuracy
    uint8_t master_clock_accuracy;
};
~~~


~~~{.c}
struct ble_gap_conn_params {
    uint16_t scan_itvl;
    uint16_t scan_window;
    uint16_t itvl_min;
    uint16_t itvl_max;
    uint16_t latency;
    uint16_t supervision_timeout;
    uint16_t min_ce_len;
    uint16_t max_ce_len;
};
~~~


~~~{.c}
struct ble_gap_disc_params {
    uint16_t itvl;
    uint16_t window;
    uint8_t filter_policy;
    uint8_t limited:1;
    uint8_t passive:1;
    uint8_t filter_duplicates:1;
};
~~~


~~~{.c}
struct ble_gap_upd_params {
    uint16_t itvl_min;
    uint16_t itvl_max;
    uint16_t latency;
    uint16_t supervision_timeout;
    uint16_t min_ce_len;
    uint16_t max_ce_len;
};
~~~


~~~{.c}
struct ble_gap_disc_desc {
    Common fields.
    uint8_t event_type;
    uint8_t length_data;
    ble_addr_t addr;
    int8_t rssi;
    uint8_t data;


     LE direct advertising report fields; direct_addr is BLE_ADDR_ANY if
     direct address fields are not present.

    ble_addr_t direct_addr;
};
~~~









 Represents a GAP-related event.  When such an event occurs, the host
 notifies the application by passing an instance of this structure to an
 application-specified callback.

~~~{.c}
struct ble_gap_event {
     Indicates the type of GAP event that occurred.  This is one of the
     BLE_GAP_EVENT codes.

    uint8_t type;

     A discriminated union containing additional details concerning the GAP
     event.  The 'type' field indicates which member of the union is valid.

    union {

         Represents a connection attempt.  Valid for the following event
         types:
             o BLE_GAP_EVENT_CONNECT

        struct {

             The status of the connection attempt;
                 o 0: the connection was successfully established.
                 o BLE host error code: the connection attempt failed for
                   the specified reason.

            int status;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } connect;


         Represents a terminated connection.  Valid for the following event
         types:
             o BLE_GAP_EVENT_DISCONNECT

        struct {

             A BLE host return code indicating the reason for the
             disconnect.

            int reason;

            Information about the connection prior to termination.
            struct ble_gap_conn_desc conn;
        } disconnect;


         Represents an advertising report received during a discovery
         procedure.  Valid for the following event types:
             o BLE_GAP_EVENT_DISC

        struct ble_gap_disc_desc disc;

#if MYNEWT_VAL(BLE_EXT_ADV)

         Represents an extended advertising report received during a discovery
         procedure.  Valid for the following event types:
             o BLE_GAP_EVENT_EXT_DISC

        struct ble_gap_ext_disc_desc ext_disc;
#endif


         Represents a completed discovery procedure.  Valid for the following
         event types:
             o BLE_GAP_EVENT_DISC_COMPLETE

~~~{.c}
        struct {

             The reason the discovery procedure stopped.  Typical reason
             codes are:
                 o 0: Duration expired.
                 o BLE_HS_EPREEMPTED: Host aborted procedure to configure a
                   peer's identity.

            int reason;
        } disc_complete;
~~~


         Represents a completed advertise procedure.  Valid for the following
         event types:
             o BLE_GAP_EVENT_ADV_COMPLETE

~~~{.c}
        struct {

             The reason the advertise procedure stopped.  Typical reason
             codes are:
                 o 0: Terminated due to connection.
                 o BLE_HS_ETIMEOUT: Duration expired.
                 o BLE_HS_EPREEMPTED: Host aborted procedure to configure a
                   peer's identity.

            int reason;

#if MYNEWT_VAL(BLE_EXT_ADV)
            Advertising instance
            uint8_t instance;
            The handle of the relevant connection - valid if reason=0
            uint16_t conn_handle;

             Number of completed extended advertising events

             This field is only valid if non-zero max_events was passed to
             ble_gap_ext_adv_start() and advertising completed due to duration
             timeout or max events transmitted.

            uint8_t num_ext_adv_events;
#endif
        } adv_complete;
~~~


         Represents an attempt to update a connection's parameters.  If the
         attempt was successful, the connection's descriptor reflects the
         updated parameters.

         Valid for the following event types:
             o BLE_GAP_EVENT_CONN_UPDATE

~~~{.c}
        struct {

             The result of the connection update attempt;
                 o 0: the connection was successfully updated.
                 o BLE host error code: the connection update attempt failed
                   for the specified reason.

            int status;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } conn_update;
~~~


         Represents a peer's request to update the connection parameters.
         This event is generated when a peer performs any of the following
         procedures:
             o L2CAP Connection Parameter Update Procedure
             o Link-Layer Connection Parameters Request Procedure

         To reject the request, return a non-zero HCI error code.  The value
         returned is the reject reason given to the controller.

         Valid for the following event types:
             o BLE_GAP_EVENT_L2CAP_UPDATE_REQ
             o BLE_GAP_EVENT_CONN_UPDATE_REQ

~~~{.c}
        struct {

             Indicates the connection parameters that the peer would like to
             use.

            const struct ble_gap_upd_params peer_params;


             Indicates the connection parameters that the local device would
             like to use.  The application callback should fill this in.  By
             default, this struct contains the requested parameters (i.e.,
             it is a copy of 'peer_params').

            struct ble_gap_upd_params self_params;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } conn_update_req;
~~~


         Represents a failed attempt to terminate an established connection.
         Valid for the following event types:
             o BLE_GAP_EVENT_TERM_FAILURE

~~~{.c}
        struct {

             A BLE host return code indicating the reason for the failure.

            int status;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } term_failure;
~~~


         Represents an attempt to change the encrypted state of a
         connection.  If the attempt was successful, the connection
         descriptor reflects the updated encrypted state.

         Valid for the following event types:
             o BLE_GAP_EVENT_ENC_CHANGE

~~~{.c}
        struct {

             Indicates the result of the encryption state change attempt;
                 o 0: the encrypted state was successfully updated;
                 o BLE host error code: the encryption state change attempt
                   failed for the specified reason.

            int status;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } enc_change;
~~~


         Represents a passkey query needed to complete a pairing procedure.

         Valid for the following event types:
             o BLE_GAP_EVENT_PASSKEY_ACTION

~~~{.c}
        struct {
            Contains details about the passkey query.
            struct ble_gap_passkey_params params;

            The handle of the relevant connection.
            uint16_t conn_handle;
        } passkey;
~~~


         Represents a received ATT notification or indication.

         Valid for the following event types:
             o BLE_GAP_EVENT_NOTIFY_RX

~~~{.c}
        struct {

             The contents of the notification or indication.  If the
             application wishes to retain this mbuf for later use, it must
             set this pointer to NULL to prevent the stack from freeing it.

            struct os_mbuf om;

            The handle of the relevant ATT attribute.
            uint16_t attr_handle;

            The handle of the relevant connection.
            uint16_t conn_handle;


             Whether the received command is a notification or an
             indication;
                 o 0: Notification;
                 o 1: Indication.

            uint8_t indication:1;
        } notify_rx;
~~~


         Represents a transmitted ATT notification or indication, or a
         completed indication transaction.

         Valid for the following event types:
             o BLE_GAP_EVENT_NOTIFY_TX

~~~{.c}
        struct {

             The status of the notification or indication transaction;
                 o 0:                 Command successfully sent;
                 o BLE_HS_EDONE:      Confirmation (indication ack) received;
                 o BLE_HS_ETIMEOUT:   Confirmation (indication ack) never
                                          received;
                 o Other return code: Error.

            int status;

            The handle of the relevant connection.
            uint16_t conn_handle;

            The handle of the relevant characterstic value.
            uint16_t attr_handle;


             Whether the transmitted command is a notification or an
             indication;
                 o 0: Notification;
                 o 1: Indication.

            uint8_t indication:1;
        } notify_tx;
~~~


         Represents a state change in a peer's subscription status.  In this
         comment, the term "update" is used to refer to either a notification
         or an indication.  This event is triggered by any of the following
         occurrences:
             o Peer enables or disables updates via a CCCD write.
             o Connection is about to be terminated and the peer is
               subscribed to updates.
             o Peer is now subscribed to updates after its state was restored
               from persistence.  This happens when bonding is restored.

         Valid for the following event types:
             o BLE_GAP_EVENT_SUBSCRIBE

~~~{.c}
        struct {
            The handle of the relevant connection.
            uint16_t conn_handle;

            The value handle of the relevant characteristic.
            uint16_t attr_handle;

            One of the BLE_GAP_SUBSCRIBE_REASON codes.
            uint8_t reason;

            Whether the peer was previously subscribed to notifications.
            uint8_t prev_notify:1;

            Whether the peer is currently subscribed to notifications.
            uint8_t cur_notify:1;

            Whether the peer was previously subscribed to indications.
            uint8_t prev_indicate:1;

            Whether the peer is currently subscribed to indications.
            uint8_t cur_indicate:1;
        } subscribe;
~~~


         Represents a change in an L2CAP channel's MTU.

         Valid for the following event types:
             o BLE_GAP_EVENT_MTU

~~~{.c}
        struct {
            The handle of the relevant connection.
            uint16_t conn_handle;


             Indicates the channel whose MTU has been updated; either
             BLE_L2CAP_CID_ATT or the ID of a connection-oriented channel.

            uint16_t channel_id;

            /The channel's new MTU.
            uint16_t value;
        } mtu;
~~~


         Represents a change in peer's identity. This is issued after
         successful pairing when Identity Address Information was received.

         Valid for the following event types:
             o BLE_GAP_EVENT_IDENTITY_RESOLVED

~~~{.c}
        struct {
            The handle of the relevant connection.
            uint16_t conn_handle;
        } identity_resolved;
~~~


         Represents a peer's attempt to pair despite a bond already existing.
         The application has two options for handling this event type:
             o Retry: Return BLE_GAP_REPEAT_PAIRING_RETRY after deleting the
                      conflicting bond.  The stack will verify the bond has
                      been deleted and continue the pairing procedure.  If
                      the bond is still present, this event will be reported
                      again.
             o Ignore: Return BLE_GAP_REPEAT_PAIRING_IGNORE.  The stack will
                       silently ignore the pairing request.

         Valid for the following event types:
             o BLE_GAP_EVENT_REPEAT_PAIRING

        struct ble_gap_repeat_pairing repeat_pairing;



         Represents a change of PHY. This is issue after successful
         change on PHY.

~~~{.c}
        struct {
            int status;
            uint16_t conn_handle;


             Indicates enabled TX/RX PHY. Possible values:
                 o BLE_GAP_LE_PHY_1M
                 o BLE_GAP_LE_PHY_2M
                 o BLE_GAP_LE_PHY_CODED

            uint8_t tx_phy;
            uint8_t rx_phy;
        } phy_updated;
    };
}
~~~


    3.3 NimBLE GATT Struct
    BLE gatt error struct.

~~~{.c}
        struct ble_gatt_error {
            uint16_t status;
            uint16_t att_handle;
        };
~~~

    BLE gatt sevices struct.

~~~{.c}
    struct ble_gatt_svc {
        uint16_t start_handle;
        uint16_t end_handle;
        ble_uuid_any_t uuid;
    };
~~~

    BLE gatt attribution struct.

~~~{.c}
    struct ble_gatt_attr {
        uint16_t handle;
        uint16_t offset;
        struct os_mbuf om;
    };
~~~

    BLE gatt characteristic struct.
~~~{.c}
    struct ble_gatt_chr {
        uint16_t def_handle;
        uint16_t val_handle;
        uint8_t properties;
        ble_uuid_any_t uuid;
    };
~~~
    
    
    BLE gatt description for callback.
~~~{.c}
    struct ble_gatt_dsc {
        uint16_t handle;
        ble_uuid_any_t uuid;
    };
~~~


    BLE gatt MTU callback function type.
~~~(.c)
    typedef int ble_gatt_mtu_fn(uint16_t conn_handle,
                                const struct ble_gatt_error error,
                                uint16_t mtu, void arg);
~~~
    
    
    BLE gatt discovery services callback function type.
~~~(.c)
    typedef int ble_gatt_disc_svc_fn(uint16_t conn_handle,
                                     const struct ble_gatt_error error,
                                     const struct ble_gatt_svc service,
                                     void arg);
~~~
    
    
The host will free the attribute mbuf automatically after the callback is
executed.  The application can take ownership of the mbuf and prevent it
from being freed by assigning NULL to attr->om.
    
~~~{.c}
typedef int ble_gatt_attr_fn(uint16_t conn_handle,
                                 const struct ble_gatt_error error,
                                 struct ble_gatt_attr attr,
                                 void arg);
~~~
    
    
BLE gatt discovery characteristic callback function type.

~~~{.c}
    typedef int ble_gatt_chr_fn(uint16_t conn_handle,
                                const struct ble_gatt_error error,
                                const struct ble_gatt_chr chr, void arg);
~~~
    
    
BLE gatt discovery descriptions callback function type.

~~~{.c}
    typedef int ble_gatt_dsc_fn(uint16_t conn_handle,
                                const struct ble_gatt_error error,
                                uint16_t chr_def_handle,
                                const struct ble_gatt_dsc dsc,
                                void arg);
    
~~~
    
Callback function type after characteristic is read or written.

~~~{.c}
    typedef int ble_gatt_access_fn(uint16_t conn_handle, uint16_t attr_handle,
                                   struct ble_gatt_access_ctxt ctxt, void arg);

~~~
    
~~~{.c}
    struct ble_gatt_chr_def {
    
          Pointer to characteristic UUID; use BLE_UUIDxx_DECLARE macros to declare
          proper UUID; NULL if there are no more characteristics in the service.
    
        const ble_uuid_t uuid;
    
          Callback that gets executed when this characteristic is read or
          written.
    
        ble_gatt_access_fn access_cb;
    
        Optional argument for callback.
        void arg;
    
    
          Array of this characteristic's descriptors.  NULL if no descriptors.
          Do not include CCCD; it gets added automatically if this
          characteristic's notify or indicate flag is set.
    
        struct ble_gatt_dsc_def descriptors;
    
        Specifies the set of permitted operations for this characteristic.
        ble_gatt_chr_flags flags;
    
        Specifies minimum required key size to access this characteristic.
        uint8_t min_key_size;
    
    
          At registration time, this is filled in with the characteristic's value
          attribute handle.
    
        uint16_t val_handle;
    };
~~~
    
~~~{.c}
    struct ble_gatt_svc_def {
    
          One of the following:
              o BLE_GATT_SVC_TYPE_PRIMARY - primary service
              o BLE_GATT_SVC_TYPE_SECONDARY - secondary service
              o 0 - No more services in this array.
    
        uint8_t type;
    
    
          Pointer to service UUID; use BLE_UUIDxx_DECLARE macros to declare
          proper UUID; NULL if there are no more characteristics in the service.
    
        const ble_uuid_t uuid;
    
    
          Array of pointers to other service definitions.  These services are
          reported as "included services" during service discovery.  Terminate the
          array with NULL.
    
        const struct ble_gatt_svc_def includes;
    
    
          Array of characteristic definitions corresponding to characteristics
          belonging to this service.
    
        const struct ble_gatt_chr_def characteristics;
    };
~~~
